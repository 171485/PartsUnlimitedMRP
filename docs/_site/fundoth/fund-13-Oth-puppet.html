<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>PartsUnlimitedMRP : Continuous Deployment with Puppet</title>
        <meta name="description" content="DevOps Hands On Labs">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/PartsUnlimitedMRP/css/syntax.css">
        <link rel="stylesheet" href="/PartsUnlimitedMRP/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <img class="logo" src="http://julienstroheker.github.io/PartsUnlimitedMRP/assets/logo-ms-dark.png" alt="Microsoft">
<h4><a class="brand" href="/PartsUnlimitedMRP/">PartsUnlimitedMRP</a>
    <small>DevOps Hands On Labs</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-3">
                        <ul class="nav nav-list">
    
        <li><a href="/PartsUnlimitedMRP/">Welcome</a></li>
    

    
        
        

        
            
                <li class="nav-header">Fundamentals using Visual Studio Team Services</li>
            

            
                <li data-order="7"><a href="/PartsUnlimitedMRP/fundvsts/fund-05-MS-LoadTest.html">Auto-Scale & Load Tests</a></li>
            
        
            

            
                <li data-order="6"><a href="/PartsUnlimitedMRP/fundvsts/fund-04-MS-tests.html">Testing with VSTS and Eclipse</a></li>
            
        
            

            
                <li data-order="5"><a href="/PartsUnlimitedMRP/fundvsts/fund-03-MS-APM.html">Application Performance Monitoring</a></li>
            
        
            

            
                <li data-order="4"><a href="/PartsUnlimitedMRP/fundvsts/fund-02-MS-CDAgent.html">Continuous Deployment with Remote Agent</a></li>
            
        
            

            
                <li data-order="3"><a href="/PartsUnlimitedMRP/fundvsts/fund-02-MS-CD.html">Continuous Deployment with Hosted agent</a></li>
            
        
            

            
                <li data-order="2"><a href="/PartsUnlimitedMRP/fundvsts/fund-01-MS-CI.html">Continuous Integration</a></li>
            
        
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/fundvsts/fund-0-MS-prereq.html">Set up Parts Unlimited MRP</a></li>
            
        
    
        
        

        
            
                <li class="nav-header">Fundamentals using Other Tools</li>
            

            
                <li data-order="5"><a href="/PartsUnlimitedMRP/fundoth/fund-14-Oth-chef.html">Continuous Deployment with Chef</a></li>
            
        
            

            
                <li data-order="4"><a class="nav-active" href="/PartsUnlimitedMRP/fundoth/fund-13-Oth-puppet.html">Continuous Deployment with Puppet</a></li>  
            
        
            

            
                <li data-order="3"><a href="/PartsUnlimitedMRP/fundoth/fund-12-Oth-CD.html">Continuous Deployment with Jenkins</a></li>
            
        
            

            
                <li data-order="2"><a href="/PartsUnlimitedMRP/fundoth/fund-11-Oth-CI.html">Continuous Integration with Jenkins</a></li>
            
        
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/fundoth/fund-10-Oth-prereq.html">Set up Parts Unlimited MRP</a></li>
            
        
    
        
        

        
    
        
        

        
            
                <li class="nav-header">Advanced</li>
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/adv/adv-21-Docker.html">Microservices with Docker</a></li>
            
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-9">
                        <div class="page-header">
    <h2>Continuous Deployment with Puppet
        
    </h2>
</div>

<h1 id="deploying-the-parts-unlimited-mrp-app-via-puppet-in-azure">Deploying the Parts Unlimited MRP App via Puppet in Azure</h1>
<p>In this hands-on lab, you will deploy a Java app, the Parts Unlimited MRP App, using Puppet from <a href="https://puppetlabs.com/">PuppetLabs</a>. Puppet is a configuration
management system that allows you to automate provisioning and configuration of machines by describing the state of your infrastructure
as code. Infrastructure as Code is an important pillar of good DevOps.</p>

<h2 id="prerequisites">Prerequisites</h2>
<ul>
  <li>An SSH client such as PuTTY</li>
  <li>An Azure subscription</li>
</ul>

<h2 id="tasks">Tasks</h2>

<p>In this lab you will work with two machines: a Puppet Master machine and another machine known as a <em>node</em>
which will host the MRP application. The only task you will perform on the node is to install the Puppet
agent - the rest of the configuration will be applied by instructing Puppet how to configure the node 
though <em>puppet programs</em> on the Puppet Master.</p>

<ol>
  <li>Provisioning a Puppet Master and node (both Ubuntu VMs) in Azure using ARM templates</li>
  <li>Install Puppet Agent on the node</li>
  <li>Configure the Puppet Production Environment</li>
  <li>Test the Production Environment Configuration</li>
  <li>Create a Puppet program to describe the environment for the MRP application</li>
</ol>

<h2 id="task-1-provision-the-lab">Task 1: Provision the Lab</h2>

<ol>
  <li>
    <p>Provision the Lab machines using an Azure Resource Manager (ARM) Template</p>

    <p>This lab calls for the use of two machines. The Puppet Master server must be a Linux machine, but the puppet
 agent can run on Linux or Windows. For this lab, the <em>node</em> that we will be configuring is an Ubuntu VM.</p>

    <p>Instead of manually creating the VMs in Azure, we are going to use an Azure Resource Management (ARM) template.</p>
  </li>
  <li>
    <p>Click on the “Deploy to Azure” button</p>

    <p>Simply click the Deploy to Azure button below and follow the wizard to deploy the two machines. You will need
 to log in to the Azure Portal.</p>

    <p><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoft%2FPartsUnlimitedMRP%2Fmaster%2Fdocs%2FHOL_Deploying-Using-Puppet%2Fenv%2FPuppetPartsUnlimitedMRP.json" target="_blank">
     <img src="http://azuredeploy.net/deploybutton.png" />
 </a>
 <a href="http://armviz.io/#/?load=https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoft%2FPartsUnlimitedMRP%2Fmaster%2Fdocs%2FHOL_Deploying-Using-Puppet%2Fenv%2FPuppetPartsUnlimitedMRP.json" target="_blank">
     <img src="http://armviz.io/visualizebutton.png" />
 </a></p>

    <p>The VMs will be deployed to a Resource Group along with a virtual network (VNET) and some other required resources. You can 
 delete the resource group in order to remove all the created resources at any time.</p>
  </li>
  <li>
    <p>Specify settings for the deployment</p>

    <p>You will need to select a subscription and region to deploy the Resource Group to and to supply an admin username 
 and password and unique name for both machines. The Puppet Master will be a Standard D2_V2 while the partsmrp machine
 will be a Standard A2.</p>

    <p><img src="../assets/puppet/1.jpg" alt="" /></p>

    <p>Make sure you make a note of the region as well as the usernames and passwords for the machines. Allow
 about 10 minutes for deployment and then another 10 minutes for the Puppet Master to configure Puppet.</p>
  </li>
  <li>
    <p>Check the Resource Group in the Azure Portal
 When the deployment completes, you should see the following resources in the Azure Portal:</p>

    <p><img src="../assets/puppet/2.jpg" alt="" /></p>

    <p>Click on the “partspuppetmaster” Public IP Address. Then make a note of the DNS name:</p>

    <p><img src="../assets/puppet/3.jpg" alt="" /></p>

    <p>The <em>dnsaddress</em> will be of the form <em>machinename</em>.<em>region</em>.cloudapp.azure.com. Open a browser to https://<em>dnsaddress</em>.
 (Make sure you’re going to http__s__, not http). You will be prompted about an invalid certificate - it is safe to
 ignore this for the purposes of this lab. If the Puppet configuration has succeeded, you should see the Puppet Console
 sign in page:</p>

    <p><img src="../assets/puppet/4.jpg" alt="" /></p>

    <blockquote>
      <p><strong>Note:</strong> The lab requires several ports to be open, such as the Puppet Server port, the Puppet console port, SSH
 ports and the Parts Unlimited MRP app port on the partsmrp machine. The ARM template opens these ports on the
 machines for you.</p>
    </blockquote>
  </li>
  <li>
    <p>Log in to the Puppet Console</p>

    <p>Now go back to the Puppet Console in your browser and enter the username <code class="highlighter-rouge">admin</code> and the password you set. 
 When you log in, you should see a page like this:</p>

    <p><img src="../assets/puppet/6.jpg" alt="" /></p>
  </li>
</ol>

<h2 id="task-3-install-puppet-agent-on-the-node">Task 3: Install Puppet Agent on the node</h2>

<p>You are now ready to add the node to the Puppet Master. Once the node is added, the Puppet Master will be able to configure
the node.</p>

<ol>
  <li>
    <p>Get the Puppet Master internal DNS name
 Go to Nodes -&gt; Unsigned Certificates. The page that loads will show a command
 that we need to run on the node. In the example below, the puppet master machine name is:</p>

    <p><code class="highlighter-rouge">
 partspuppetmaster.nqkkrckzqwwu1p5pu4ntvzrona.cx.internal.cloudapp.net
</code>
 <img src="../assets/puppet/8.jpg" alt="" /></p>
  </li>
  <li>
    <p>Run the “Add Node” command on the node</p>

    <p>Copy the “Add Node” command from the Puppet Console (the one that starts with <code class="highlighter-rouge">curl...</code>) and go to the SSH terminal of
 the node. Run the command.
 <img src="../assets/puppet/11.jpg" alt="" /></p>

    <p>The command will take a few moments to complete.</p>

    <p>From here on, you will configure the node only from the Puppet Master, though you will use the partsmrp SSH
 terminal to manually force Puppet to configure it.</p>
  </li>
  <li>
    <p>Accept the Pending Node Request</p>

    <p>Return to the Puppet Console and refresh the Unsigned Certificates page (where you previously got the node install command). You
 should see a pending request. This request has come from the node and will authorize the certificate between the puppet
 master and the node so that they can communicate securely. Press “Accept” to approve the node:
 <img src="../assets/puppet/12.jpg" alt="" /></p>

    <p>Click on the “Nodes” tab in the Puppet Console to return to the nodes view. You should see 2 nodes listed: 
 the puppet master and the partsmrp node (it may take a few minutes for the mrp node to finish configuration before it appears)</p>

    <p><img src="../assets/puppet/13.jpg" alt="" /></p>

    <blockquote>
      <p><strong>Note:</strong> It is possible to automate the install and configuration of the Puppet agent onto an Azure VM using the
 <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/puppet-agent-windows">Puppet Agent extension</a> from the 
 Azure Marketplace.</p>
    </blockquote>
  </li>
</ol>

<h2 id="task-4-configure-the-puppet-production-environment">Task 4: Configure the Puppet Production Environment</h2>

<p>The Parts Unlimited MRP application is a Java application that requires <a href="https://www.mongodb.org/">mongodb</a>
and <a href="http://tomcat.apache.org/">tomcat</a> to be installed and configured on the partsmrp machine (the node). Instead of
installing and configuring manually, we will now write a puppet program that will instruct the node how to configure
itself.</p>

<p>Puppet Programs are stored in a particular folder in the puppet master. Puppet programs are made up of manifests
that describe the desired state of the node(s). The manifests can consume modules, which are pre-packaged Puppet
Programs. Users can create their own modules or consume modules from a marketplace maintained by PuppetLabs known
as the <a href="http://forge.puppetlabs.com">Forge</a>. Some modules on the Forge are official modules that are supported - 
others are open-source modules uploaded from the community.</p>

<p>Puppet Programs are organized by environment, allowing you to manage different catalogs for different environments such as dev, test and production.</p>

<p>For the purposes of this lab, we will treat the node as if it were in the production environment. We will also need to 
download a few modules from the Forge which we will consume to configure the node.</p>

<p>When the Puppet Server was installed in Azure, it configured a folder for managing the production environment
in <code class="highlighter-rouge">/etc/puppetlabs/code/environments/production</code>.</p>

<ol>
  <li>
    <p>Inspect the Production modules
 On the SSH terminal to the Puppet Master, cd to that folder now:</p>

    <p><code class="highlighter-rouge">sh
 cd /etc/puppetlabs/code/environments/production
</code></p>

    <p>If you run <code class="highlighter-rouge">ls</code> you will see the <code class="highlighter-rouge">manifests</code> and <code class="highlighter-rouge">modules</code> folders. The <code class="highlighter-rouge">manifests</code> folder contains descriptions
 of machines that we will later apply to nodes. The <code class="highlighter-rouge">modules</code> folder contains any modules that are referenced
 within the manifests.</p>
  </li>
  <li>
    <p>Install additional Puppet Forge Modules
 We will now install some modules from the Puppet Forge that we will need to configure the <code class="highlighter-rouge">partsmrp</code> node. Run
 the following 3 commands:</p>

    <p><code class="highlighter-rouge">sh
 sudo puppet module install puppetlabs-mongodb
 sudo puppet module install puppetlabs-tomcat
 sudo puppet module install maestrodev-wget
</code></p>

    <p><img src="../assets/puppet/14.jpg" alt="" /></p>

    <blockquote>
      <p><strong>Note:</strong> The <code class="highlighter-rouge">mongodb</code> and <code class="highlighter-rouge">tomcat</code> modules are supported modules from the Forge. The <code class="highlighter-rouge">wget</code> module is
 a user module and so is not officially supported.</p>
    </blockquote>
  </li>
  <li>
    <p>Create a Custom Module</p>

    <p>We will now create a custom module that will configure the Parts Unlimited MRP app. Run the following commands
 to template a module:</p>

    <p><code class="highlighter-rouge">sh
 cd /etc/puppetlabs/puppet/environments/production/modules
 sudo puppet module generate partsunlimited-mrpapp
</code></p>

    <p>This will start a wizard that will ask a series of questions as it scaffolds the module. Simply press <code class="highlighter-rouge">enter</code>
 for each question (accepting blank or default) until the wizard completes.</p>

    <p>Running <code class="highlighter-rouge">ls -la</code> should list the modules available so far, including <code class="highlighter-rouge">mrpapp</code>:</p>

    <p><img src="../assets/puppet/15.jpg" alt="" /></p>
  </li>
  <li>
    <p>Configure the default node in the site.pp file</p>

    <p>We are going to define the node’s configuration in the <code class="highlighter-rouge">mrpapp</code> module. The configuration of the nodes in the
 production environment is defined in a <code class="highlighter-rouge">site.pp</code> file in the production <code class="highlighter-rouge">manifests</code> folder (the <code class="highlighter-rouge">.pp</code> extension
 is short for “puppet program”). Let’s edit the <code class="highlighter-rouge">site.pp</code> file and define the configuration for our node:</p>

    <p><code class="highlighter-rouge">sh
 sudo nano /etc/puppetlabs/code/environments/production/manifests/site.pp
</code></p>

    <p>Scroll to the bottom of the file and edit the <code class="highlighter-rouge">node default</code> section. Edit it to look as follows:</p>

    <p><code class="highlighter-rouge">puppet
 node default {
   class { 'mrpapp': }
 }
</code></p>

    <p>Press <code class="highlighter-rouge">cntrl-X</code>, then <code class="highlighter-rouge">y</code> then <code class="highlighter-rouge">enter</code> to save the changes to the file.</p>

    <p>This instructs Puppet to configure the <code class="highlighter-rouge">default</code> (that is, all nodes) with the <code class="highlighter-rouge">mrpapp</code> module. The module (though
 currently empty) is in the <code class="highlighter-rouge">modules</code> folder of the production environment, so Puppet will know where to find
 it.</p>
  </li>
</ol>

<h2 id="task-5-test-the-production-environment-configuration">Task 5: Test the Production Environment Configuration</h2>

<p>Before we fully describe the MRP app for the node, let’s test that everything is hooked up correctly by 
configuring a “dummy” file in the <code class="highlighter-rouge">mrpapp</code> module. If Puppet executes and creates the dummy file, then we can
flesh out the rest of the module properly.</p>

<ol>
  <li>
    <p>Edit the init.pp file</p>

    <p>Let’s edit the <code class="highlighter-rouge">init.pp</code> file of the <code class="highlighter-rouge">mrpapp</code> module (this is the entry point for the module):</p>

    <p><code class="highlighter-rouge">sh
 sudo nano /etc/puppetlabs/code/environments/production/modules/mrpapp/manifests/init.pp
</code></p>

    <p>You can either delete all the boiler-plate comments or just ignore them. Scroll down to the <code class="highlighter-rouge">class mrpapp</code>
 declaration and make it look as follows:</p>

    <p><code class="highlighter-rouge">puppet
 class mrpapp {
     file { '/tmp/dummy.txt':
         ensure =&gt; 'present',
         content =&gt; 'Puppet rules!',
     }
 }
</code></p>

    <p>Press <code class="highlighter-rouge">cntrl-X</code>, then <code class="highlighter-rouge">y</code> then <code class="highlighter-rouge">enter</code> to save the changes to the file.</p>

    <blockquote>
      <p><strong>Note:</strong> Classes in Puppet programs are not like classes in Object Oriented Programming. They simply define
 a “resource” that is conifgured on a node. In the <code class="highlighter-rouge">mrpapp</code> class (or resource), we have just instructed 
 Puppet to ensure that a file exists at the path <code class="highlighter-rouge">/tmp/dummy.txt</code> that has the content “Puppet rules!”. We 
 will define more advanced resources within the <code class="highlighter-rouge">mrpapp</code> class as we progress.</p>
    </blockquote>
  </li>
  <li>
    <p>Test the dummy file</p>

    <p>Let’s test our setup. Switch to the <code class="highlighter-rouge">partsmrp</code> SSH terminal and enter the following command:</p>

    <p><code class="highlighter-rouge">sh
 sudo puppet agent --test
</code></p>

    <p>By default, the Puppet agents will query the Puppet Master for their configuration every 30 minutes. The
 command you just entered forces the agent to ask the Puppet Master for its configuration. It then tests
 itself against the configuration, and does whatever it needs to do in order to make itself match that
 configuration. In this case, the configuration requires the <code class="highlighter-rouge">/tmp/dummy.txt</code> file, so the node creates
 the file accordingly.</p>

    <p>You should see a successful run on the node. <code class="highlighter-rouge">cat</code> the <code class="highlighter-rouge">/tmp/dummy.txt</code> file to inspect its contents:</p>

    <p><code class="highlighter-rouge">sh
 cat /tmp/dummy.txt
</code></p>

    <p><img src="../assets/puppet/16.jpg" alt="" /></p>
  </li>
  <li>
    <p>Correct configuration drift</p>

    <p>Puppet will automatically detect configuration drift and fix it. By default, the agent runs every 30 minutes on
 the nodes. Each time the agent runs, Puppet will determine if the environment is in the correct state - if it is
 not, it will reapply classes as necessary.</p>

    <p>Let’s simulate configuration drift by deleting the dummy file and then re-running the puppet agent:</p>

    <p><code class="highlighter-rouge">sh
 sudo rm /tmp/dummy.txt
 sudo puppet agent --test
 cat /tmp/dummy.txt
</code></p>

    <p>You should see the run complete successfully and the file should exist again.</p>

    <p><img src="../assets/puppet/17.jpg" alt="" /></p>

    <p>You can also try to edit the contents of the file and re-run the <code class="highlighter-rouge">sudo puppet agent --test</code> command to see the 
 contents update.</p>
  </li>
</ol>

<h2 id="task-6-create-a-puppet-program-to-describe-the-prerequisites-for-the-mrp-application">Task 6: Create a Puppet Program to Describe the Prerequisites for the MRP Application</h2>

<p>Now that we have hooked up the node (partsmrp) to the Puppet Master, we can begin to write the Puppet Program
that will describe the prerequisites for the Parts Unlimited MRP application.</p>

<blockquote>
  <p><strong>Note:</strong> For simplicity, we will describe the entire configuration in a single Puppet Program (init.pp from 
the mrpapp module we created earlier). However, the parts of the configuration could be split into multiple 
manifests or modules as they grow. This would promote reuse - just as in any good programming language.</p>
</blockquote>

<blockquote>
  <p><strong>Note:</strong> You can see the complete <code class="highlighter-rouge">init.pp</code> file <a href="final/init.pp">here</a>.</p>
</blockquote>

<h3 id="configure-mongodb">6.1 Configure MongoDb</h3>

<p>Let’s add a class to configure mongodb. Once mongodb is configured, we want Puppet to donwload a mongo script
that contains some data for our application’s database. We’ll include this as part of the mongodb setup.</p>

<p>On the Puppet Master, edit the init.pp file of the mrpapp module:
<code class="highlighter-rouge">sh
sudo nano /etc/puppetlabs/puppet/environments/production/modules/mrpapp/manifests/init.pp
</code></p>

<p>Add the following class at the bottom of the file:</p>

<div class="language-puppet highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">configuremongodb</span> <span class="p">{</span>
  <span class="k">include</span> <span class="nc">wget</span>
  <span class="k">class</span> <span class="p">{</span> <span class="s1">'mongodb'</span><span class="p">:</span> <span class="p">}-&gt;</span>

  <span class="n">wget::fetch</span> <span class="p">{</span> <span class="s1">'mongorecords'</span><span class="p">:</span>
    <span class="py">source</span> <span class="p">=&gt;</span> <span class="s1">'https://raw.githubusercontent.com/Microsoft/PartsUnlimitedMRP/master/deploy/MongoRecords.js'</span><span class="p">,</span>
    <span class="py">destination</span> <span class="p">=&gt;</span> <span class="s1">'/tmp/MongoRecords.js'</span><span class="p">,</span>
    <span class="py">timeout</span> <span class="p">=&gt;</span> <span class="m">0</span><span class="p">,</span>
  <span class="p">}-&gt;</span>
  <span class="n">exec</span> <span class="p">{</span> <span class="s1">'insertrecords'</span><span class="p">:</span>
    <span class="py">command</span> <span class="p">=&gt;</span> <span class="s1">'mongo ordering /tmp/MongoRecords.js'</span><span class="p">,</span>
    <span class="py">path</span> <span class="p">=&gt;</span> <span class="s1">'/usr/bin:/usr/sbin'</span><span class="p">,</span>
    <span class="py">unless</span> <span class="p">=&gt;</span> <span class="s1">'test -f /tmp/initcomplete'</span>
  <span class="p">}-&gt;</span>
  <span class="n">file</span> <span class="p">{</span> <span class="s1">'/tmp/initcomplete'</span><span class="p">:</span>
    <span class="py">ensure</span> <span class="p">=&gt;</span> <span class="s1">'present'</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Let’s examine this class:
- Line 1: We create a class (resource) called <code class="highlighter-rouge">configuremongodb</code>
- Line 2: We include the <code class="highlighter-rouge">wget</code> <a href="https://forge.puppetlabs.com/maestrodev/wget">module</a> so that we can 
download files via <code class="highlighter-rouge">wget</code>
- Line 3: We invoke the <code class="highlighter-rouge">mondodb</code> resource (from the <code class="highlighter-rouge">mongodb</code> module we downloaded earlier). This installs
mongodb using defaults defined in the <a href="https://forge.puppetlabs.com/puppetlabs/mongodb">Puppet mongodb module</a>.
Believe it or not, that’s all we have to do to install mondodb!
- Line 5: We invoke the <code class="highlighter-rouge">fetch</code> resource from the <code class="highlighter-rouge">wget</code> module, calling this resource <code class="highlighter-rouge">mongorecords</code>
- Line 6: We set the source of the file we need to download
- Line 7: We set the destination where the file must be downloaded to
- Line 10: We use the built-in Puppet resource <code class="highlighter-rouge">exec</code> to execute a command
- Line 11: We specify the command to execute
- Line 12: We set the path for the command invocation
- Line 13: We specify a condition using the keyword <code class="highlighter-rouge">unless</code>: we only want this command to execute once, so we
create a tmp file once we have inserted the records (Line 15). If this file exists, we don’t execute the
command again.</p>

<blockquote>
  <p><strong>Note</strong>: The <code class="highlighter-rouge">-&gt;</code> notation on Lines 3, 9 and 14 is an “ordering arrow”: it tells Puppet that it must apply the
“left” resource before invoking the “right” resource. This allows us to specify order when necessary.</p>
</blockquote>

<p>Press <code class="highlighter-rouge">cntrl-O</code>, then <code class="highlighter-rouge">enter</code> to save the changes to the file without exiting.</p>

<h3 id="configure-java">6.2 Configure Java</h3>

<p>Add the following class below the <code class="highlighter-rouge">configuremongodb</code> class:</p>

<div class="language-puppet highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">configurejava</span> <span class="p">{</span>
  <span class="k">include</span> <span class="nc">apt</span>
  <span class="nv">$packages</span> <span class="err">=</span> <span class="p">[</span><span class="s1">'openjdk-8-jdk'</span><span class="p">,</span> <span class="s1">'openjdk-8-jre'</span><span class="p">]</span>

  <span class="n">apt::ppa</span> <span class="p">{</span> <span class="s1">'ppa:openjdk-r/ppa'</span><span class="p">:</span> <span class="p">}-&gt;</span>
  <span class="n">package</span> <span class="p">{</span> <span class="nv">$packages</span><span class="p">:</span>
     <span class="py">ensure</span> <span class="p">=&gt;</span> <span class="s1">'installed'</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Let’s examine this class:
- Line 2: We include the <code class="highlighter-rouge">apt</code> module, which will allow us to configure new Personal Package Archives (PPAs)
- Line 3: We create an array of packages that we need to install 
- Line 5: We add a PPA
- Lines 6 - 8: We tell Puppet to ensure that the package are installed. Puppet expands the array and essentially
does a for-each, installing each package in the array.</p>

<blockquote>
  <p><strong>Note:</strong> We can’t use the Puppet <code class="highlighter-rouge">package</code> target to install Java since this will only install Java 7. That’s
why we needed to add the PPA using the <code class="highlighter-rouge">apt</code> module.</p>
</blockquote>

<p>Press <code class="highlighter-rouge">cntrl-O</code>, then <code class="highlighter-rouge">enter</code> to save the changes to the file without exiting.</p>

<h3 id="configure-tomcat">6.3 Configure Tomcat</h3>

<p>Let’s add a class below the <code class="highlighter-rouge">configurejava</code> class to configure <code class="highlighter-rouge">tomcat</code>:</p>

<div class="language-puppet highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">configuretomcat</span> <span class="p">{</span>
  <span class="k">class</span> <span class="p">{</span> <span class="s1">'tomcat'</span><span class="p">:</span> <span class="p">}</span>

  <span class="n">tomcat::instance</span> <span class="p">{</span> <span class="s1">'default'</span><span class="p">:</span>
    <span class="py">package_name</span> <span class="p">=&gt;</span> <span class="s1">'tomcat7'</span><span class="p">,</span>
    <span class="py">install_from_source</span> <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">}-&gt;</span>
  <span class="n">tomcat::config::server::connector</span> <span class="p">{</span> <span class="s1">'tomcat7-http'</span><span class="p">:</span>
    <span class="py">catalina_base</span> <span class="p">=&gt;</span> <span class="s1">'/var/lib/tomcat7'</span><span class="p">,</span>
    <span class="py">port</span> <span class="p">=&gt;</span> <span class="s1">'9080'</span><span class="p">,</span>
    <span class="py">protocol</span> <span class="p">=&gt;</span> <span class="s1">'HTTP/1.1'</span><span class="p">,</span>
    <span class="py">connector_ensure</span> <span class="p">=&gt;</span> <span class="s1">'present'</span><span class="p">,</span>
    <span class="py">server_config</span> <span class="p">=&gt;</span> <span class="s1">'/etc/tomcat7/server.xml'</span><span class="p">,</span>
  <span class="p">}-&gt;</span>
  <span class="n">tomcat::service</span> <span class="p">{</span> <span class="s1">'default'</span><span class="p">:</span>
    <span class="py">use_jsvc</span> <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="py">use_init</span> <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="py">service_name</span> <span class="p">=&gt;</span> <span class="s1">'tomcat7'</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Let’s examine this class:
- Line 1: We create a class (resource) called <code class="highlighter-rouge">configuretomcat</code>
- Line 2: We invoke the <code class="highlighter-rouge">tomcat</code> resource (from the <a href="https://forge.puppetlabs.com/puppetlabs/mongodb">tomcat module</a>
we downloaded earlier)
- Line 4: We need to override some default properties for the tomcat instance. We specify the tomcat package we
need (Line 5) and tell the <code class="highlighter-rouge">tomcat</code> class not to install from source (Line 6).
- Lines 8 - 14: We configure the Tomcat service
- Lines 15 - 19: We need to configure a connector for the Parts Unlimited MRP application. In Lines 9 - 13, we specify
the connector properties for Puppet to write to the tomcat server.xml file.</p>

<p>Press <code class="highlighter-rouge">cntrl-O</code>, then <code class="highlighter-rouge">enter</code> to save the changes to the file without exiting.</p>

<h3 id="deploy-a-war-file">6.4 Deploy a WAR File</h3>

<p>The MRP application is compiled into a WAR file that Tomcat then uses to serve pages.</p>

<p>Let’s specify a resource to deploy the war file for the site. Go back to the Puppet SSH session and edit the <code class="highlighter-rouge">init.pp</code> file. 
Add the following class at the bottom of the file:</p>

<div class="language-puppet highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">deploywar</span> <span class="p">{</span>
  <span class="n">require</span> <span class="n">configuretomcat</span>

  <span class="n">tomcat::war</span> <span class="p">{</span> <span class="s1">'mrp.war'</span><span class="p">:</span>
    <span class="py">catalina_base</span> <span class="p">=&gt;</span> <span class="s1">'/var/lib/tomcat7'</span><span class="p">,</span>
    <span class="py">war_source</span> <span class="p">=&gt;</span> <span class="s1">'https://raw.githubusercontent.com/Microsoft/PartsUnlimitedMRP/master/builds/mrp.war'</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Let’s examine this class:
- Line 1: We create a class (resource) called <code class="highlighter-rouge">deploywar</code>
- Line 2: We tell Puppet to make sure that <code class="highlighter-rouge">configuretomcat</code> is complete before invoking this class
- Line 5: We set the <code class="highlighter-rouge">catalina base</code> directory so that Puppet deploys the war to our Tomcat service
- Line 6: We use the tomcat module’s <code class="highlighter-rouge">war</code> resource to deploy our war from the <code class="highlighter-rouge">war_source</code></p>

<h3 id="start-the-ordering-service">6.5 Start the Ordering Service</h3>

<p>The MRP service calls an Ordering Service, which is a REST API managing orders in the MongoDb. This service is compiled to a 
jar file. We’ll need to copy the jar file to our node and then run it in the background so that it can listen for requests.</p>

<p>Now we need to make sure that the ordering service is running. Again we’ll add a new class at the bottom of the <code class="highlighter-rouge">init.pp</code> file:</p>

<div class="language-puppet highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">orderingservice</span> <span class="p">{</span>
  <span class="n">package</span> <span class="p">{</span> <span class="s1">'openjdk-7-jre'</span><span class="p">:</span>
    <span class="py">ensure</span> <span class="p">=&gt;</span> <span class="s1">'installed'</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="n">file</span> <span class="p">{</span> <span class="s1">'/opt/mrp'</span><span class="p">:</span>
    <span class="py">ensure</span> <span class="p">=&gt;</span> <span class="s1">'directory'</span>
  <span class="p">}-&gt;</span>
  <span class="n">wget::fetch</span> <span class="p">{</span> <span class="s1">'orderingsvc'</span><span class="p">:</span>
    <span class="py">source</span> <span class="p">=&gt;</span> <span class="s1">'https://raw.githubusercontent.com/Microsoft/PartsUnlimitedMRP/master/builds/ordering-service-0.1.0.jar'</span><span class="p">,</span>
    <span class="py">destination</span> <span class="p">=&gt;</span> <span class="s1">'/opt/mrp/ordering-service.jar'</span><span class="p">,</span>
    <span class="py">cache_dir</span> <span class="p">=&gt;</span> <span class="s1">'/var/cache/wget'</span><span class="p">,</span>
    <span class="py">timeout</span> <span class="p">=&gt;</span> <span class="m">0</span><span class="p">,</span>
  <span class="p">}-&gt;</span>
  <span class="n">exec</span> <span class="p">{</span> <span class="s1">'stoporderingservice'</span><span class="p">:</span>
    <span class="py">command</span> <span class="p">=&gt;</span> <span class="s2">"pkill -f ordering-service"</span><span class="p">,</span>
    <span class="py">path</span> <span class="p">=&gt;</span> <span class="s1">'/bin:/usr/bin:/usr/sbin'</span><span class="p">,</span>
    <span class="py">onlyif</span> <span class="p">=&gt;</span> <span class="s2">"pgrep -f ordering-service"</span>
  <span class="p">}-&gt;</span>
  <span class="n">exec</span> <span class="p">{</span> <span class="s1">'stoptomcat'</span><span class="p">:</span>
    <span class="py">command</span> <span class="p">=&gt;</span> <span class="s1">'service tomcat7 stop'</span><span class="p">,</span>
    <span class="py">path</span> <span class="p">=&gt;</span> <span class="s1">'/usr/bin:/usr/sbin'</span><span class="p">,</span>
    <span class="py">onlyif</span> <span class="p">=&gt;</span> <span class="s2">"test -f /etc/init.d/tomcat7"</span><span class="p">,</span>
  <span class="p">}-&gt;</span>
  <span class="n">exec</span> <span class="p">{</span> <span class="s1">'orderservice'</span><span class="p">:</span>
    <span class="py">command</span> <span class="p">=&gt;</span> <span class="s1">'java -jar /opt/mrp/ordering-service.jar &amp;'</span><span class="p">,</span>
    <span class="py">path</span> <span class="p">=&gt;</span> <span class="s1">'/usr/bin:/usr/sbin:/usr/lib/jvm/java-8-openjdk-amd64/bin'</span><span class="p">,</span>
  <span class="p">}-&gt;</span>
  <span class="n">exec</span> <span class="p">{</span> <span class="s1">'wait'</span><span class="p">:</span>
    <span class="py">command</span> <span class="p">=&gt;</span> <span class="s1">'sleep 20'</span><span class="p">,</span>
    <span class="py">path</span> <span class="p">=&gt;</span> <span class="s1">'/bin'</span><span class="p">,</span>
    <span class="kp">notify</span> <span class="p">=&gt;</span> <span class="nc">Tomcat</span><span class="p">::</span><span class="nc">Service</span><span class="p">[</span><span class="s1">'default'</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Let’s examine this class:
- Line 1: We create a class (resource) called <code class="highlighter-rouge">orderingservice</code>
- Lines 2 - 4: We install the Java JRE required to run the application using Puppet’s <code class="highlighter-rouge">package</code> resource
- Lines 6 - 8: We ensure that the directory <code class="highlighter-rouge">/opt/mrp</code> exists (Puppet creates it if it doesnt)
- Lines 9 - 14: We <code class="highlighter-rouge">wget</code> the ordering service binary, placing it in <code class="highlighter-rouge">/opt/mrp</code>
- Line 12: We specify a cache directory to ensure that the file is only downloaded once
- Lines 15 - 19: We stop the <code class="highlighter-rouge">orderingservice</code>, but only if it is running
- Lines 20 - 24: We stop the <code class="highlighter-rouge">tomcat7</code> service, but only if it is running
- Lines 25 - 28: We start the ordering service
- Lines 29 - 33: We sleep for 20 seconds to give the ordering service time to start up before <code class="highlighter-rouge">notifying</code>
the <code class="highlighter-rouge">tomcat</code> service, which triggers a refresh on the service - Puppet will re-apply the state we defined
for the service (i.e. start it if it is not running)</p>

<blockquote>
  <p><strong>Note:</strong> We need to wait after running the <code class="highlighter-rouge">java</code> command since this service needs to be running before we
start Tomcat, otherwise Tomcat grabs the port that the ordering service needs to listen on.</p>
</blockquote>

<h3 id="complete-the-mrpapp-resource">6.6 Complete the mrpapp Resource</h3>

<p>Go back to the top of the file and change the <code class="highlighter-rouge">mrpapp</code> class to look as follows to run all our resources:</p>

<div class="language-puppet highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">mrpapp</span> <span class="p">{</span>
  <span class="k">class</span> <span class="p">{</span> <span class="s1">'configuremongodb'</span><span class="p">:</span> <span class="p">}</span>
  <span class="k">class</span> <span class="p">{</span> <span class="s1">'configurejava'</span><span class="p">:</span> <span class="p">}</span>
  <span class="k">class</span> <span class="p">{</span> <span class="s1">'configuretomcat'</span><span class="p">:</span> <span class="p">}</span>
  <span class="k">class</span> <span class="p">{</span> <span class="s1">'deploywar'</span><span class="p">:</span> <span class="p">}</span>
  <span class="k">class</span> <span class="p">{</span> <span class="s1">'orderingservice'</span><span class="p">:</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Press <code class="highlighter-rouge">cntrl-O</code>, then <code class="highlighter-rouge">enter</code> to save the changes to the file without exiting.</p>

<h2 id="task-7-run-the-puppet-configuration-on-the-node">Task 7: Run the Puppet Configuration on the Node</h2>

<ol>
  <li>
    <p>Run the Puppet Agent
 On the partsmrp SSH session, again force Puppet to update the node’s configuration:
 <code class="highlighter-rouge">sh
 sudo puppet agent --test
</code></p>

    <p>This first run will take a few moments - there is lots to download and install for the first run! Next time the Puppet agent runs,
 it will verify that the existing environment is correctly configured - that should be much quicker since the services will already
 be installed and configured.</p>
  </li>
  <li>
    <p>Verify that Tomcat is running</p>

    <p>Open a browser and browse to port <code class="highlighter-rouge">9080</code> of the partsmrp machine. You can get the name of the machine by clicking on the Public IP
 resource for the machine in Azure (just like you did to get the url of the puppet master earlier). Once you open the browser, you 
 should see the following Tomcat confirmation page:</p>

    <p><img src="../assets/puppet/20.jpg" alt="" /></p>
  </li>
  <li>
    <p>Verify that the PartsMRP Application is running correctly</p>

    <p>Now you can ensure that the configuration is correct by opening a browser to the Parts Unlimited MRP application. The address
 will be http://partsmrp-public-ip:9080/mrp where <em>partsmrp-public-ip</em> is the public ip or DNS name of the
 partsmrp VM (you can get it by clicking on the VM in the resource group in the Azure Portal).</p>

    <p><img src="../assets/puppet/18.jpg" alt="" /></p>

    <p>If you click on the Orders button, you should see the orders page:</p>

    <p><img src="../assets/puppet/19.jpg" alt="" /></p>
  </li>
</ol>

<blockquote>
  <p><strong>Note:</strong> You can see the complete <code class="highlighter-rouge">init.pp</code> file <a href="final/init.pp">here</a>.</p>
</blockquote>

<p>In this lab, you learned how to create the Puppet infrastructure and deploy the Parts Unlimited MRP app to the nodes while managing configuration drift.</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/Microsoft/PartsUnlimitedMRP">PartsUnlimitedMRP</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
