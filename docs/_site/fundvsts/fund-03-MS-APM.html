<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>PartsUnlimitedMRP : Application Performance Monitoring</title>
        <meta name="description" content="DevOps Hands On Labs">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/PartsUnlimitedMRP/css/syntax.css">
        <link rel="stylesheet" href="/PartsUnlimitedMRP/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <img class="logo" src="http://julienstroheker.github.io/PartsUnlimitedMRP/assets/logo-ms-dark.png" alt="Microsoft">
<h4><a class="brand" href="/PartsUnlimitedMRP/">PartsUnlimitedMRP</a>
    <small>DevOps Hands On Labs</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-3">
                        <ul class="nav nav-list">
    
        <li><a href="/PartsUnlimitedMRP/">Welcome</a></li>
    

    
        
        

        
            
                <li class="nav-header">Fundamentals using Visual Studio Team Services</li>
            

            
                <li data-order="7"><a href="/PartsUnlimitedMRP/fundvsts/fund-05-MS-LoadTest.html">Auto-Scale & Load Tests</a></li>
            
        
            

            
                <li data-order="6"><a href="/PartsUnlimitedMRP/fundvsts/fund-04-MS-tests.html">Testing with VSTS and Eclipse</a></li>
            
        
            

            
                <li data-order="5"><a class="nav-active" href="/PartsUnlimitedMRP/fundvsts/fund-03-MS-APM.html">Application Performance Monitoring</a></li>  
            
        
            

            
                <li data-order="4"><a href="/PartsUnlimitedMRP/fundvsts/fund-02-MS-CDAgent.html">Continuous Deployment with Remote Agent</a></li>
            
        
            

            
                <li data-order="3"><a href="/PartsUnlimitedMRP/fundvsts/fund-02-MS-CD.html">Continuous Deployment with Hosted agent</a></li>
            
        
            

            
                <li data-order="2"><a href="/PartsUnlimitedMRP/fundvsts/fund-01-MS-CI.html">Continuous Integration</a></li>
            
        
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/fundvsts/fund-0-MS-prereq.html">Set up Parts Unlimited MRP</a></li>
            
        
    
        
        

        
            
                <li class="nav-header">Fundamentals using Other Tools</li>
            

            
                <li data-order="5"><a href="/PartsUnlimitedMRP/fundoth/fund-14-Oth-chef.html">Continuous Deployment with Chef</a></li>
            
        
            

            
                <li data-order="4"><a href="/PartsUnlimitedMRP/fundoth/fund-13-Oth-puppet.html">Continuous Deployment with Puppet</a></li>
            
        
            

            
                <li data-order="3"><a href="/PartsUnlimitedMRP/fundoth/fund-12-Oth-CD.html">Continuous Deployment with Jenkins</a></li>
            
        
            

            
                <li data-order="2"><a href="/PartsUnlimitedMRP/fundoth/fund-11-Oth-CI.html">Continuous Integration with Jenkins</a></li>
            
        
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/fundoth/fund-10-Oth-prereq.html">Set up Parts Unlimited MRP</a></li>
            
        
    
        
        

        
    
        
        

        
            
                <li class="nav-header">Advanced</li>
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/adv/adv-21-Docker.html">Microservices with Docker</a></li>
            
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-9">
                        <div class="page-header">
    <h2>Application Performance Monitoring
        
    </h2>
</div>

<h3 id="application-performance-monitoring-using-microsoft-azure-application-insights">Application Performance Monitoring using Microsoft Azure Application Insights</h3>

<p>The DevOps team has noticed that the Dealers page is slow to load and shows performance spikes with database calls in the Application Insights telemetry. By viewing the details of performance monitoring through Application Insights, we will be able to drill down to the code that has affected the slow performance of the web application and fix the code.</p>

<p>In this lab, you will learn how to set up Application Insights telemetry, and drill down into performance monitoring data through Application Insights in the new Azure Portal.</p>

<p><strong>Prerequisites</strong></p>

<ul>
  <li>
    <p>Code Editor (VSCode, Eclipse, etc.)</p>
  </li>
  <li>
    <p>Continuous Integration build with Gradle to the PartsUnlimitedMRP virtual machine (see <a href="https://github.com/Microsoft/PartsUnlimitedMRP/tree/master/docs/HOL_Continuous-Integration">link</a>)</p>
  </li>
  <li>
    <p>Continuous Deployment with hosted agent (see <a href="https://github.com/Microsoft/PartsUnlimitedMRP/tree/master/docs/HOL_Continuous-Deployment">link</a>)</p>
  </li>
</ul>

<p><strong>Tasks Overview</strong></p>

<ol>
  <li>
    <p>Set up Application Insights for PartsUnlimitedMRP</p>
  </li>
  <li>
    <p>Using Application Performance Monitoring to resolve performance issues</p>
  </li>
</ol>

<h3 id="task-1-create-the-application-insights-resource-on-azure">Task 1: Create the Application Insights Resource on Azure</h3>
<p><strong>Step 1.</strong> In an Internet browser, navigate to <a href="http://portal.azure.com">http://portal.azure.com</a> and
sign in with your credentials.</p>

<p><img src="../assets/appperf/prereq-step1.png" alt="" /></p>

<p><strong>Step 2.</strong> Click on the “+ New” tile on the left column, Search for
“Application Insights,” and click on the first result “Application Insights (preview)”</p>

<p><img src="../assets/appperf/creation_AppInsight.png" alt="" /></p>

<p><strong>Step 3.</strong> Fill the information asked, choose the Application Type for “Java web application”. We recommand to deploy this resource in the same Resource Group that you choose for the virtual machine in the previous HOL.</p>

<p><img src="../assets/appperf/creation_AppInsight2.png" alt="" /></p>

<h3 id="task-2-set-up-application-insights-for-partsunlimitedmrp">Task 2: Set up Application Insights for PartsUnlimitedMRP</h3>
<p><strong>Step 1.</strong> Still from the Azure Portal : <a href="http://portal.azure.com">http://portal.azure.com</a></p>

<p><img src="../assets/appperf/prereq-step1.png" alt="" /></p>

<p><strong>Step 3.</strong> Open you Application Insights telemetry service previsously created for PartsUnlimitedMRP, select the Settings tile, followed by the Properties tile to find the Instrumentation key.</p>

<p><img src="../assets/appperf/prereq-step3.png" alt="" /></p>

<p><strong>Step 4.</strong> Copy the Instrumentation Key in the Properties panel. You will need this when inserting the key into the ApplicationInsights.xml file in PartsUnlimitedMRP’s resources folder.</p>

<p><img src="../assets/appperf/prereq-step4.png" alt="" /></p>

<p><strong>Step 5.</strong> Navigate to the working folders of the PartsUnlimitedMRP repo in a code editor (such as VSCode).</p>

<p><img src="../assets/appperf/prereq-step5.png" alt="" /></p>

<p><strong>Step 6.</strong> In <code class="highlighter-rouge">PartsUnlimitedMRP/src/Backend/OrderService/build.gradle</code>, confirm that the build file is importing <code class="highlighter-rouge">com.microsoft.appinsights.*</code> and is also compiling <code class="highlighter-rouge">com.microsoft.azure:applicationinsights-core:1.n</code>.</p>

<p><img src="../assets/appperf/prereq-step6.png" alt="" /></p>

<p><strong>Step 7.</strong> In <code class="highlighter-rouge">PartsUnlimitedMRP/src/OrderService/src/main/resources/ApplicationInsights.xml</code>, paste in the instrumentation key that you copied previously from the Azure Portal in between the <code class="highlighter-rouge">&lt;InstrumentationKey&gt;</code> tags.</p>

<p><img src="../assets/appperf/prereq-step7.png" alt="" /></p>

<p><strong>Step 8.</strong> Additionally, verify that the following telemetry modules and telemetry initializers exist in between the <code class="highlighter-rouge">&lt;TelemetryModules&gt;</code> and <code class="highlighter-rouge">&lt;TelemetryIntializers&gt;</code> tags.</p>

<p>Telemetry Modules:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;Add type="com.microsoft.applicationinsights.web.extensibility.modules.WebRequestTrackingTelemetryModule"/&gt;
&lt;Add type="com.microsoft.applicationinsights.web.extensibility.modules.WebSessionTrackingTelemetryModule"/&gt;
&lt;Add type="com.microsoft.applicationinsights.web.extensibility.modules.WebUserTrackingTelemetryModule"/&gt;		
</code></pre>
</div>

<p>Telemetry Initializers:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;Add type="com.microsoft.applicationinsights.web.extensibility.initializers.WebOperationIdTelemetryInitializer"/&gt;
&lt;Add type="com.microsoft.applicationinsights.web.extensibility.initializers.WebOperationNameTelemetryInitializer"/&gt;
&lt;Add type="com.microsoft.applicationinsights.web.extensibility.initializers.WebSessionTelemetryInitializer"/&gt;
&lt;Add type="com.microsoft.applicationinsights.web.extensibility.initializers.WebUserTelemetryInitializer"/&gt;
&lt;Add type="com.microsoft.applicationinsights.web.extensibility.initializers.WebUserAgentTelemetryInitializer"/&gt;
</code></pre>
</div>

<p><img src="../assets/appperf/prereq-step8.png" alt="" /></p>

<p><strong>Step 9.</strong> Return to the Azure Portal and under the Application Insights telemetry for PartsUnlimitedMRP, click on the tile in the overview timeline for application health, “Learn how to collect browser page load data.” Once you click on it, a new panel should open that shows the end-user usage analytics code. Copy lines 8 through 17 (the script itself).</p>

<p><img src="../assets/appperf/prereq-step9.png" alt="" /></p>

<p><strong>Step 10.</strong> Back in the code editor, we will want to insert the script code previously copied before the end of the <code class="highlighter-rouge">&lt;HEAD&gt;</code> tag for each of the HTML pages in PartsUnlimitedMRP, starting with the index page. In <code class="highlighter-rouge">PartsUnlimitedMRP/src/Clients/Web/index.html</code>, paste the script code before the other scripts inside of the <code class="highlighter-rouge">&lt;HEAD&gt;</code> tag.</p>

<p><img src="../assets/appperf/prereq-step10.png" alt="" /></p>

<p><strong>Step 10.</strong> Repeat step 10 for the following HTML files:</p>

<ul>
  <li><code class="highlighter-rouge">PartsUnlimitedMRP/src/Clients/Web/pages/catalog/catalog.html</code></li>
  <li><code class="highlighter-rouge">PartsUnlimitedMRP/src/Clients/Web/pages/dealers/dealers.html</code></li>
  <li><code class="highlighter-rouge">PartsUnlimitedMRP/src/Clients/Web/pages/deliveries/deliveries.html</code></li>
  <li><code class="highlighter-rouge">PartsUnlimitedMRP/src/Clients/Web/pages/orders/orders.html</code></li>
  <li><code class="highlighter-rouge">PartsUnlimitedMRP/src/Clients/Web/pages/quotes/quotes.html</code></li>
</ul>

<p><strong>Step 11.</strong> Commit and push the changes to kick off the Continuous Integration build with Gradle.</p>

<p><img src="../assets/appperf/prereq-step11.png" alt="" /></p>

<p><img src="../assets/appperf/prereq-step11b.png" alt="" /></p>

<p><strong>Step 12.</strong> Return to the Azure Portal into the PartsUnlimitedMRP Application Insights telemetry to find data available for browser page loading and dependency durations. It may take a few moments for Application Insights to reload.</p>

<p><img src="../assets/appperf/prereq-step12.png" alt="" /></p>

<h3 id="task-3-using-application-performance-monitoring-to-resolve-performance-issues">Task 3: Using Application Performance Monitoring to resolve performance issues</h3>

<p><strong>Step 1.</strong> In an Internet browser, navigate to the PartsUnlimitedMRP website that you previously deployed and go to the Dealers page. You’ll notice immediately that the page takes a while for the dealers to load on the left-hand side.</p>

<p><img src="../assets/appperf/step1.png" alt="" /></p>

<p><strong>Step 2.</strong> Click on the “Browse All” tile on the left column, select
“Application Insights,” and click on the name of your Application Insights
telemetry for your web app.</p>

<p><img src="../assets/appperf/prereq-step2.png" alt="" /></p>

<p><strong>Step 3.</strong> After selecting the Application Insights telemetry for your web app,
scroll down and select the “Performance” tile to view performance monitoring
information.</p>

<p><img src="../assets/appperf/step3.png" alt="" /></p>

<p><strong>Step 4.</strong> In the performance tile of the Application Insights telemetry, note
the timeline. The timeline data may not show up immediately, so you will want to wait for a few minutes for the telemetry to collect performance data.</p>

<p><img src="../assets/appperf/view_dealers_app_insights.png" alt="" /></p>

<p><strong>Step 5.</strong> Once data shows in the timeline, view the operations listed under the <strong>Average
of server response time by operation name</strong> section under the timeline. Click on the top operation in the list referring to the Dealers page to view details of that operation.</p>

<p><strong>Step 6.</strong> Drill down into the method that is affecting the slow performance. We now know that the slow performance is being caused by the DealersController in our code and that this is causing inefficient database calls.</p>

<p><strong>Step 7.</strong> Navigate to the working folders of the PartsUnlimitedMRP repo in a code editor (such as VSCode).</p>

<p><img src="../assets/appperf/prereq-step5.png" alt="" /></p>

<p><strong>Step 8.</strong> Find the <code class="highlighter-rouge">getDealers()</code> method in <code class="highlighter-rouge">PartsUnlimitedMRP/src/Backend/OrderService/src/main/java/smpl/ordering/controllers/DealerController.java</code> that is causing slow performance.</p>

<p><img src="../assets/appperf/step8.png" alt="" /></p>

<p><strong>Step 9.</strong> In the <code class="highlighter-rouge">getDealers()</code> method, notice that there is a database call 100000 times with the variable, <code class="highlighter-rouge">numMongoDBCalls</code>. Change the value of this variable to be 1 so that there is only one call to the database to populate the dealers list.</p>

<p><img src="../assets/appperf/step9.png" alt="" /></p>

<p><strong>Step 10.</strong> Save the changes and commit the changes on the master branch. Push the changes to the remote repo in VSO to kick off a Continuous Integration build.</p>

<p><img src="../assets/appperf/step10.png" alt="" /></p>

<p><img src="../assets/appperf/prereq-step11b.png" alt="" /></p>

<p><strong>Step 11.</strong> Now that our changes have deployed to the website, open up a new incognito browser window (to prevent caching) and return to the Dealers page. The dealers will show up faster than they did previously now having one call to the database.</p>

<p><img src="../assets/appperf/step1.png" alt="" /></p>

<p><strong>Step 12.</strong> Return to the Application Insights performance monitoring view in the Azure Preview Portal and refresh the page. The <strong>Average of server response time by operation name</strong> overview should not be showing the <code class="highlighter-rouge">getDealers()</code> method.</p>

<p>In this lab, you learned how to set up Application Insights telemetry, and drill down into performance
monitoring data through Application Insights in the new Azure Portal.</p>

<p><strong>Further Resources</strong></p>

<p><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-java-get-started/">Get started with Application Insights in a Java web project</a></p>

<p><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-java-collectd/">Unix performance metrics in Application Insights</a></p>

<p><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-web-track-usage-custom-events-metrics/">Application Insights API for custom events and metrics</a></p>

<h1 id="continuous-feedbacks">Continuous Feedbacks</h1>

<h4 id="issues--questions-about-this-hol-">Issues / Questions about this HOL ??</h4>

<p><a href="https://github.com/Microsoft/PartsUnlimitedMRP/issues">If you are encountering some issues or questions during this Hands on Labs, please open an issue by clicking here</a></p>

<p>Thanks</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/Microsoft/PartsUnlimitedMRP">PartsUnlimitedMRP</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
