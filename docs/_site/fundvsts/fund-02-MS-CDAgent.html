<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>PartsUnlimitedMRP : Continuous Deployment with Remote Agent</title>
        <meta name="description" content="DevOps Hands On Labs">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/PartsUnlimitedMRP/css/syntax.css">
        <link rel="stylesheet" href="/PartsUnlimitedMRP/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <img class="logo" src="http://julienstroheker.github.io/PartsUnlimitedMRP/assets/logo-ms-dark.png" alt="Microsoft">
<h4><a class="brand" href="/PartsUnlimitedMRP/">PartsUnlimitedMRP</a>
    <small>DevOps Hands On Labs</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-3">
                        <ul class="nav nav-list">
    
        <li><a href="/PartsUnlimitedMRP/">Welcome</a></li>
    

    
        
        

        
            
                <li class="nav-header">Fundamentals using Visual Studio Team Services</li>
            

            
                <li data-order="7"><a href="/PartsUnlimitedMRP/fundvsts/fund-05-MS-LoadTest.html">Auto-Scale & Load Tests</a></li>
            
        
            

            
                <li data-order="6"><a href="/PartsUnlimitedMRP/fundvsts/fund-04-MS-tests.html">Testing with VSTS and Eclipse</a></li>
            
        
            

            
                <li data-order="5"><a href="/PartsUnlimitedMRP/fundvsts/fund-03-MS-APM.html">Application Performance Monitoring</a></li>
            
        
            

            
                <li data-order="4"><a class="nav-active" href="/PartsUnlimitedMRP/fundvsts/fund-02-MS-CDAgent.html">Continuous Deployment with Remote Agent</a></li>  
            
        
            

            
                <li data-order="3"><a href="/PartsUnlimitedMRP/fundvsts/fund-02-MS-CD.html">Continuous Deployment with Hosted agent</a></li>
            
        
            

            
                <li data-order="2"><a href="/PartsUnlimitedMRP/fundvsts/fund-01-MS-CI.html">Continuous Integration</a></li>
            
        
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/fundvsts/fund-0-MS-prereq.html">Set up Parts Unlimited MRP</a></li>
            
        
    
        
        

        
            
                <li class="nav-header">Fundamentals using Other Tools</li>
            

            
                <li data-order="5"><a href="/PartsUnlimitedMRP/fundoth/fund-14-Oth-chef.html">Continuous Deployment with Chef</a></li>
            
        
            

            
                <li data-order="4"><a href="/PartsUnlimitedMRP/fundoth/fund-13-Oth-puppet.html">Continuous Deployment with Puppet</a></li>
            
        
            

            
                <li data-order="3"><a href="/PartsUnlimitedMRP/fundoth/fund-12-Oth-CD.html">Continuous Deployment with Jenkins</a></li>
            
        
            

            
                <li data-order="2"><a href="/PartsUnlimitedMRP/fundoth/fund-11-Oth-CI.html">Continuous Integration with Jenkins</a></li>
            
        
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/fundoth/fund-10-Oth-prereq.html">Set up Parts Unlimited MRP</a></li>
            
        
    
        
        

        
    
        
        

        
            
                <li class="nav-header">Advanced</li>
            

            
                <li data-order="1"><a href="/PartsUnlimitedMRP/adv/adv-21-Docker.html">Microservices with Docker</a></li>
            
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-9">
                        <div class="page-header">
    <h2>Continuous Deployment with Remote Agent
        
    </h2>
</div>

<h3 id="parts-unlimited-mrp-app-continuous-deployment-with-vsts---remote-agent">Parts Unlimited MRP App Continuous Deployment with VSTS - Remote Agent</h3>

<p>In this lab, you will learn how to deploy the Parts Unlimited MRP App in an automated fashion onto a local agent on a Linux VM. After this lab, you will have a working, automated build in Visual Studio Team Services that will build, test, and deploy the Parts Unlimited MRP app to a Virtual Machine in Azure.</p>

<blockquote>
  <p><strong>Note:</strong> If you would like to trigger continuous deployments using the hosted VSTS agent instead of a local agent, see <a href="https://github.com/Microsoft/PartsUnlimitedMRP/tree/master/docs/HOL_Continuous-Deployment">this lab</a>.</p>
</blockquote>

<h3 id="pre-requisites">Pre-requisites</h3>

<ul>
  <li><a href="https://github.com/Microsoft/PartsUnlimitedMRP/blob/master/docs/HOL_Set-Up-MRP/README.md">Completion of the “Set up Parts Unlimited MRP” lab</a></li>
  <li><a href="https://github.com/Microsoft/PartsUnlimitedMRP/blob/master/docs/HOL_Continuous-Integration/README.md">Completion of the Continuous Integration with Parts Unlimited MRP HOL</a></li>
  <li>An active Azure Subscription</li>
  <li>An active Visual Studio Team Services Account</li>
</ul>

<h3 id="tasks-overview">Tasks Overview</h3>

<p>In this lab, you will work with one machine which will serve as both the deployment agent and the MRP server.</p>

<p><strong>Provision the lab:</strong> Provision a VSTS agent and MRP machine (Ubuntu VM) in Azure using an ARM template.</p>

<p><strong>Configure the release definition:</strong> Configure a release definition in VSTS that picks up build artifacts and triggers whenever new artifacts are produced.</p>

<p><strong>Trigger a build for continuous deployment:</strong> Trigger a build for continuous deployment by making changes to code and automatically deploying the MRP app to the local agent.</p>

<h3 id="task-1-provision-the-lab">Task 1: Provision the Lab</h3>

<ol>
  <li>
    <p>Create the MRP agent pool in Visual Studio Team Services if you do not have one already. Go to the homepage of your VSTS account and clicking on the gear icon in the upper-right corner of the homepage.</p>

    <p><img src="../assets/cd-agent/vsts_gear_icon.png" alt="" /></p>
  </li>
  <li>
    <p>Then, click on the <strong>Agent Pool</strong> tab and click on <strong>New pool…</strong> to create a pool called “MRP.” Keep the checkbox to “Auto-provision Queues in all Projects” checked.</p>

    <p><img src="../assets/cd-agent/create_agent_pool.png" alt="" /></p>
  </li>
  <li>
    <p>Instead of manually creating the VM in Azure, we are going to use an Azure Resource Management (ARM) template. Simply click the <strong>Deploy to Azure</strong> button below and follow the wizard to deploy the machine. You will need to log in to the Azure Portal.</p>

    <p><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoft%2FPartsUnlimitedMRP%2Fmaster%2Fdocs%2FHOL_Continuous-Deployment-Using-Custom-Agent%2Fenv%2FContinuousDeploymentCustomAgentPartsUnlimitedMRP.json" target="_blank">
     <img src="http://azuredeploy.net/deploybutton.png" />
 </a>
 <a href="http://armviz.io/#/?load=https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoft%2FPartsUnlimitedMRP%2Fmaster%2Fdocs%2FHOL_Continuous-Deployment-Using-Custom-Agent%2Fenv%2FContinuousDeploymentCustomAgentPartsUnlimitedMRP.json" target="_blank">
     <img src="http://armviz.io/visualizebutton.png" />
 </a></p>

    <p>The VMs will be deployed to a Resource Group along with a virtual network (VNET) and some other required resources. You can 
 delete the resource group in order to remove all the created resources at any time.</p>
  </li>
  <li>
    <p>You will need to select a subscription and region to deploy the Resource Group to and supply an admin username, password, and unique name for the machine. The machine will be a Standard D1_V2.</p>

    <p><img src="../assets/cd-agent/set_arm_parameters.png" alt="" /></p>

    <p>Make sure you make a note of the region as well as the username and password for the machine. Allow about 10 minutes for deployment and then another 10 minutes for the VSTS agent and MRP dependency configuration.</p>
  </li>
  <li>
    <p>You will also need to specify the VSTS account to use (the DNS name before <em>visualstudio.com</em>) and a personal access token. If you don’t have a personal access token, follow <a href="https://www.visualstudio.com/en-us/docs/setup-admin/team-services/use-personal-access-tokens-to-authenticate">this link</a> to create one.</p>
  </li>
  <li>
    <p>When the deployment completes, you should see the following resources in the Azure Portal:</p>

    <p><img src="../assets/cd-agent/post_deployment_rg.png" alt="" /></p>

    <p>Click on the “partsmrp” Public IP Address. Then make a note of the DNS name:</p>

    <p><img src="../assets/cd-agent/public_ip_dns.png" alt="" /></p>

    <blockquote>
      <p><strong>Note:</strong> The lab requires several ports to be open, such as SSH ports and the Parts Unlimited MRP app port on the partsmrp machine. 
 The ARM template opens these ports on the machine for you.</p>
    </blockquote>
  </li>
</ol>

<h3 id="task-2-create-release-definition">Task 2: Create release definition</h3>

<ol>
  <li>
    <p>At the homepage of the PartsUnlimitedMRP team project in Visual Studio Team Services, click on the <strong>Release</strong> tab in the upper-left corner of the page. Then, click the <strong>New definition</strong> button on the home page.</p>

    <p><img src="../assets/cd-agent/new_release.png" alt="" /></p>
  </li>
  <li>
    <p>In the <strong>Create new release definition</strong> dialog, choose an empty template then the OK button.</p>

    <p><img src="../assets/cd-agent/create_empty_definition.png" alt="" /></p>
  </li>
  <li>
    <p>Keep the artifacts as <strong>Build</strong>, select the CI build definition that you used in the previous lab (such as “PartsUnlimited.CI”), check the checkbox to enable the <strong>Continuous Deployment trigger</strong>, and choose “MRP” as the  <strong>agent queue</strong>.</p>

    <p><img src="../assets/cd-agent/choose_source_queue_new_dialog.png" alt="" /></p>
  </li>
  <li>
    <p>Click on the <strong>Environment</strong> keyword and rename the environment to be “Dev.” Click on the pencil icon on the top of the definition and rename it to be PartsUnlimitedMRP.CD.</p>

    <p><img src="../assets/cd-agent/change_environment_name.png" alt="" /></p>
  </li>
  <li>
    <p>Click on the <strong>Add tasks</strong> button and add a shell script task (under the Utility category).</p>

    <p><img src="../assets/cd-agent/add_shell_script.png" alt="" /></p>
  </li>
  <li>
    <p>Point to the <strong>Deploy-MRP-App.sh</strong> build artifact as the script path in the task. Then save the release definition.</p>

    <p><img src="../assets/cd-agent/add_script_path.png" alt="" /></p>
  </li>
</ol>

<p><strong>Note</strong> : Click on the <strong>“…“</strong> to navigate in the folder and find the shell script :</p>

<p><img src="../assets/cd-agent/CD_deploy.png" alt="" /></p>

<ol>
  <li>
    <p>Click on the <strong>Triggers</strong> tab and set the artifact source by selecting the Build definition that you are created previously.</p>

    <p><img src="../assets/cd-agent/vsts_trig.png" alt="" />
 <img src="../assets/cd-agent/vsts_CD.png" alt="" /></p>
  </li>
  <li>
    <p>Click on <strong>Save</strong></p>
  </li>
</ol>

<h3 id="task-3-continuous-deployment">Task 3: Continuous Deployment</h3>

<p>Now that our release definition is set up, let’s test using Continuous Integration and Continuous Deployment.</p>

<ol>
  <li>
    <p>Navigate to the code tab and find the index.html page in src/Clients/Web/index.html. Make a change by clicking on the <strong>Edit</strong> button, then commit the change.</p>

    <p><img src="../assets/cd-agent/commit_edited_code.png" alt="" /></p>
  </li>
  <li>
    <p>Go to the <strong>Build</strong> tab and note the running build that was queued by the Continuous Integration trigger.</p>

    <p><img src="../assets/cd-agent/completed_build.png" alt="" /></p>
  </li>
  <li>
    <p>Return to the <strong>Release</strong> tab and note the running deployment that was queued by the Continuous Deployment trigger.</p>

    <p><img src="../assets/cd-agent/completed_deployment.png" alt="" /></p>
  </li>
  <li>
    <p>Verify your code change by navigating to the VM’s public IP DNS name, such as <code class="highlighter-rouge">http://mylinuxvm.westus.cloudapp.azure.com:9080/mrp</code>.</p>
  </li>
</ol>

<h2 id="next-steps">Next steps</h2>

<p>In this lab, you learned how to create deployments automatically after committing changes to code and build automatically. Try these labs out for next steps:</p>

<ul>
  <li>
    <p><a href="https://github.com/Microsoft/PartsUnlimitedMRP/tree/master/docs/HOL_Continuous-Deployment">Parts Unlimited MRP Continuous Deployment - Hosted</a></p>
  </li>
  <li>
    <p><a href="https://github.com/Microsoft/PartsUnlimitedMRP/tree/master/docs/HOL_Deploying-Using-Chef">Deploying Parts Unlimited MRP with Chef to Azure</a></p>
  </li>
  <li>
    <p><a href="https://github.com/Microsoft/PartsUnlimitedMRP/tree/master/docs/HOL_Application-Performance-Monitoring">Parts Unlimited MRP Application Performance Monitoring</a></p>
  </li>
  <li>
    <p><a href="https://github.com/Microsoft/PartsUnlimitedMRP/tree/master/docs/HOL_Autoscaling-Load-Testing">Parts Unlimited MRP Auto-Scaling and Load Testing</a></p>
  </li>
</ul>

<h1 id="continuous-feedbacks">Continuous Feedbacks</h1>

<h4 id="issues--questions-about-this-hol-">Issues / Questions about this HOL ??</h4>

<p><a href="https://github.com/Microsoft/PartsUnlimitedMRP/issues">If you are encountering some issues or questions during this Hands on Labs, please open an issue by clicking here</a></p>

<p>Thanks</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/Microsoft/PartsUnlimitedMRP">PartsUnlimitedMRP</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
